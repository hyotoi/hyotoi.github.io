name: Sync from muse_profile

on:
  repository_dispatch:
    types: [sync_triggered]

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # GITHUB_TOKENìœ¼ë¡œ push í—ˆìš©

    steps:
      # 1) B ì €ì¥ì†Œ(í˜„ì¬ repo) ì²´í¬ì•„ì›ƒ
      - name: Checkout target repo (hyotoi.github.io)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) A ì €ì¥ì†Œë¥¼ remoteë¡œ ì¶”ê°€í•˜ê³  fetch (íƒœê·¸ í¬í•¨)
      - name: Add source remote and fetch
        run: |
          set -euo pipefail
          git remote add source https://github.com/ehdwn1991/muse_profile.git
          git fetch --tags source

          # A ì €ì¥ì†Œì˜ ê¸°ë³¸ ë¸Œëœì¹˜ ìë™ ê°ì§€ (source/HEAD â†’ ë¸Œëœì¹˜ëª…)
          git remote set-head source -a || true
          SRC_DEFAULT="$(git rev-parse --abbrev-ref source/HEAD | sed 's|source/||' || echo main)"
          echo "SRC_DEFAULT=${SRC_DEFAULT}" >> $GITHUB_ENV
          echo "ğŸ” Source default branch: ${SRC_DEFAULT}"

      # 3) ëŒ€ìƒ(B) ê¸°ë³¸ ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ
      - name: Switch to target default branch
        env:
          TARGET_DEFAULT: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail
          BRANCH="${TARGET_DEFAULT:-main}"
          echo "TARGET_DEFAULT=${BRANCH}" >> $GITHUB_ENV
          echo "ğŸ” Checkout target branch: ${BRANCH}"
          git checkout "${BRANCH}"

      # 4) ë³‘í•© í•„ìš” ì—¬ë¶€ í™•ì¸ (ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ìŠ¤í‚µ)
      - name: Skip if already up to date
        run: |
          set -euo pipefail
          if git merge-base --is-ancestor "source/${SRC_DEFAULT}" HEAD; then
            echo "âœ… Already up to date. Skipping merge & push."
            echo "SKIP_MERGE=1" >> $GITHUB_ENV
          else
            echo "SKIP_MERGE=0" >> $GITHUB_ENV
          fi

      # 5) Merge (ì¶©ëŒ ì‹œ source ìª½ ì„ í˜¸: -X theirs)
      - name: Merge source into target
        if: env.SKIP_MERGE == '0'
        run: |
          set -euo pipefail
          # ì„œë¡œ ë‹¤ë¥¸ íˆìŠ¤í† ë¦¬ë„ í—ˆìš©í•˜ê³ , ì¶©ëŒ ì‹œ source(=theirs) ìš°ì„ 
          git merge --no-edit --allow-unrelated-histories -X theirs "source/${SRC_DEFAULT}" \
            || (echo "âŒ Merge conflict. Please resolve manually."; exit 1)

      # 6) ë³€ê²½ ì‚¬í•­ì´ ìˆìœ¼ë©´ push
      - name: Push merge result
        if: env.SKIP_MERGE == '0'
        run: |
          set -euo pipefail
          git push origin "HEAD:${TARGET_DEFAULT}"
          echo "ğŸš€ Pushed merged changes to ${TARGET_DEFAULT}"
