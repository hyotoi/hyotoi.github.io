name: Sync from muse_profile

on:
  repository_dispatch:
    types: [sync_triggered]

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # GITHUB_TOKENÏúºÎ°ú push ÌóàÏö©

    steps:
      # 1) B Ï†ÄÏû•ÏÜå(ÌòÑÏû¨ repo) Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout target repo (hyotoi.github.io)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) A Ï†ÄÏû•ÏÜåÎ•º remoteÎ°ú Ï∂îÍ∞ÄÌïòÍ≥† fetch (ÌÉúÍ∑∏ Ìè¨Ìï®)
      - name: Add source remote and fetch
        run: |
          set -euo pipefail
          git remote add source https://github.com/ehdwn1991/muse_profile.git || true

          # üîß Clean local tags to avoid clobber on fetch
          git tag -l | xargs -r -n 1 git tag -d || true

          # üì• Fetch source with tags (force), and prune removed refs
          git fetch source --prune --tags --force

          # A Ï†ÄÏû•ÏÜåÏùò Í∏∞Î≥∏ Î∏åÎûúÏπò ÏûêÎèô Í∞êÏßÄ (source/HEAD ‚Üí Î∏åÎûúÏπòÎ™Ö)
          git remote set-head source -a || true
          SRC_DEFAULT="$(git rev-parse --abbrev-ref source/HEAD | sed 's|source/||' || echo main)"
          echo "SRC_DEFAULT=${SRC_DEFAULT}" >> $GITHUB_ENV
          echo "üîé Source default branch: ${SRC_DEFAULT}"

      # 3) ÎåÄÏÉÅ(B) Í∏∞Î≥∏ Î∏åÎûúÏπò Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Switch to target default branch
        env:
          TARGET_DEFAULT: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail
          BRANCH="${TARGET_DEFAULT:-main}"
          echo "TARGET_DEFAULT=${BRANCH}" >> $GITHUB_ENV
          echo "üîÅ Checkout target branch: ${BRANCH}"
          git checkout "${BRANCH}"

      # 4) Î≥ëÌï© ÌïÑÏöî Ïó¨Î∂Ä ÌôïÏù∏ (Ïù¥ÎØ∏ Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏúºÎ©¥ Ïä§ÌÇµ)
      - name: Skip if already up to date
        run: |
          set -euo pipefail
          if git merge-base --is-ancestor "source/${SRC_DEFAULT}" HEAD; then
            echo "‚úÖ Already up to date. Skipping merge & push."
            echo "SKIP_MERGE=1" >> $GITHUB_ENV
          else
            echo "SKIP_MERGE=0" >> $GITHUB_ENV
          fi

      # 5) Sync source into target with commit
      - name: Sync source into target with commit
        if: env.SKIP_MERGE == '0'
        run: |
          set -euo pipefail
          git rm -r . || true
          git checkout "source/${SRC_DEFAULT}" -- .
          git add .
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "ü§ñ Sync from muse_profile" || echo "No changes to commit"

      # 6) Î≥ÄÍ≤Ω ÏÇ¨Ìï≠Ïù¥ ÏûàÏúºÎ©¥ push
      - name: Push merge result
        if: env.SKIP_MERGE == '0'
        run: |
          set -euo pipefail
          git push origin "HEAD:${TARGET_DEFAULT}" --force
          git push origin --tags --force
          echo "üöÄ Pushed merged changes and tags to ${TARGET_DEFAULT}"
