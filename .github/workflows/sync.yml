name: Sync from muse_profile

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 12 * *"  # ë§¤ì¼ ë‚® 12ì‹œ
  repository_dispatch:
    types: [sync_triggered]  # ì™¸ë¶€ì—ì„œ APIë¡œ íŠ¸ë¦¬ê±°

permissions:
  contents: write          # ë¸Œëœì¹˜/ë¦´ë¦¬ìŠ¤ ìƒì„±
  pull-requests: write     # PR ìƒì„±
  workflows: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Detect target branch
        id: detect
        run: |
          echo "BRANCH=${{ github.event.repository.default_branch }}" >> $GITHUB_ENV
          echo "ts=$(date -u +%Y%m%d-%H%M%S)" >> $GITHUB_ENV

      - name: Sync fork via REST API (merge-upstream)
        id: merge_upstream
        env:
          GH_OWNER: ${{ github.repository_owner }}
          GH_REPO:  ${{ github.event.repository.name }}
          BRANCH:   ${{ env.BRANCH }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "â¡ï¸ Syncing ${GH_OWNER}/${GH_REPO}:${BRANCH} from upstream (merge-upstream API)â€¦"
          RESP_CODE=$(curl -sS -w "%{http_code}" -o /tmp/resp.json -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/merge-upstream" \
            -d "{\"branch\":\"${BRANCH}\"}")

          echo "HTTP ${RESP_CODE}"
          echo "Response:" && cat /tmp/resp.json || true
          echo "code=${RESP_CODE}" >> $GITHUB_OUTPUT

          # If the upstream includes workflow file changes, GitHub App token without 'workflows: write' yields 422.
          # Map 422 to 409 to trigger PR flow instead of failing.
          if [ "${RESP_CODE}" = "422" ]; then
            echo "âš ï¸  Received 422 (likely workflow file update not permitted). Falling back to PR flow."
            # Override the step output to mimic 409 so downstream steps run.
            echo "code=409" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "${RESP_CODE}" = "200" ]; then
            echo "âœ… Fast-forward ì™„ë£Œ (Sync fork)."
            exit 0
          elif [ "${RESP_CODE}" = "409" ]; then
            echo "âš ï¸ ì¶©ëŒ ë˜ëŠ” fast-forward ë¶ˆê°€. PRë¡œ ì²˜ë¦¬ ë‹¨ê³„ë¡œ ì§„í–‰í•©ë‹ˆë‹¤."
            exit 0
          else
            echo "âŒ ì‹¤íŒ¨ (HTTP ${RESP_CODE})"
            exit 1
          fi

      # === 200 ì²˜ë¦¬: ë¦´ë¦¬ìŠ¤ ìë™ ìƒì„± (ìë™ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸) ===
      - name: Create auto-generated release notes
        if: steps.merge_upstream.outputs.code == '200'
        env:
          GH_OWNER: ${{ github.repository_owner }}
          GH_REPO:  ${{ github.event.repository.name }}
          BRANCH:   ${{ env.BRANCH }}
          TS:       ${{ env.ts }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="sync-${BRANCH}-${TS}"
          TITLE="ğŸ¤– Sync upstream on ${TS} (${BRANCH})"
          echo "â¡ï¸ Creating release ${TAG}"
          curl -sS -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/releases" \
            -d "{
              \"tag_name\": \"${TAG}\",
              \"target_commitish\": \"${BRANCH}\",
              \"name\": \"${TITLE}\",
              \"generate_release_notes\": true
            }" \
            | tee /tmp/release.json

      # === 409 ì²˜ë¦¬: ìë™ PR ìƒì„± ===
      - name: Checkout (for PR branch creation)
        if: steps.merge_upstream.outputs.code == '409'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare PR branch from upstream tip
        if: steps.merge_upstream.outputs.code == '409'
        env:
          BRANCH: ${{ env.BRANCH }}
        run: |
          set -euo pipefail
          git remote add upstream https://github.com/${{ github.repository_owner }}/${{ github.event.repository.name }}.git || true
          # upstream URLì„ í¬í¬ ì„¤ì •ì—ì„œ ìë™ ì¶”ì í•  ìˆ˜ ì—†ìœ¼ë‹ˆ, í•„ìš” ì‹œ ìˆ˜ë™ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”:
          # git remote set-url upstream https://github.com/<UPSTREAM_OWNER>/<UPSTREAM_REPO>.git

          # ê¸°ë³¸ì ìœ¼ë¡œ GitHub í¬í¬ ê´€ê³„ê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ upstream ë¦¬ëª¨íŠ¸ê°€ ìë™ ì¶”ì ë©ë‹ˆë‹¤.
          git fetch upstream --prune --tags
          NEW_BRANCH="sync/${BRANCH}-${{ env.ts }}"
          git checkout -B "${NEW_BRANCH}" "upstream/${BRANCH}"
          git push origin "${NEW_BRANCH}"
          echo "NEW_BRANCH=${NEW_BRANCH}" >> $GITHUB_ENV

      - name: Open Pull Request (upstream â†’ fork base)
        if: steps.merge_upstream.outputs.code == '409'
        env:
          GH_OWNER: ${{ github.repository_owner }}
          GH_REPO:  ${{ github.event.repository.name }}
          BRANCH:   ${{ env.BRANCH }}
          NEW_BRANCH: ${{ env.NEW_BRANCH }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TITLE="Sync upstream into ${BRANCH}"
          BODY="This PR was created automatically because the fork could not be fast-forwarded via **merge-upstream**.\n\n- Base: \`${BRANCH}\`\n- Head: \`${NEW_BRANCH}\`\n\nAfter merge, the fork will be aligned with upstream."
          PR_RESP=$(curl -sS -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/pulls" \
            -d "{
              \"title\": \"${TITLE}\",
              \"head\": \"${NEW_BRANCH}\",
              \"base\": \"${BRANCH}\",
              \"body\": ${BODY@Q}
            }")
          echo "${PR_RESP}"
